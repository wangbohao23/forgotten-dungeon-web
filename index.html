<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—å¿˜åœ°ç‰¢ | Forgotten Dungeon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body {
            font-family: 'Courier New', 'VT323', monospace;
            background: linear-gradient(135deg, #0d0d0d 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #00ff41;
            overflow-x: hidden;
        }

        /* CRT å±å¹•æ•ˆæœ */
        .crt-container {
            position: relative;
            min-height: 100vh;
            padding: 20px;
        }

        .crt-container::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1),
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1000;
        }

        .crt-container::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, transparent 50%, rgba(0, 0, 0, 0.4) 100%);
            pointer-events: none;
            z-index: 999;
        }

        /* ä¸»å®¹å™¨ */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        /* ä¾§è¾¹æ  - ç©å®¶çŠ¶æ€ */
        .sidebar {
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #00ff41;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2), inset 0 0 20px rgba(0, 255, 65, 0.05);
            overflow-y: auto;
            min-height: 0;
        }

        .sidebar > * {
            flex-shrink: 0;
        }

        .sidebar h2 {
            color: #00ff41;
            font-size: 24px;
            text-align: center;
            border-bottom: 1px solid #00ff41;
            padding-bottom: 10px;
            text-shadow: 0 0 10px #00ff41;
        }

        .stat-box {
            background: rgba(0, 40, 0, 0.5);
            border: 1px solid #008f11;
            border-radius: 5px;
            padding: 12px;
            min-height: 80px;
        }

        .stat-box h3 {
            color: #00cc33;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            font-size: 13px;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            color: #00ff41;
            font-weight: bold;
        }

        /* HP æ¡ */
        .hp-bar-container {
            margin-top: 5px;
        }

        .hp-bar {
            width: 100%;
            height: 18px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 3px;
            overflow: hidden;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff3333, #ff6600, #00ff41);
            transition: width 0.3s ease;
        }

        .hp-text {
            text-align: center;
            font-size: 11px;
            margin-top: 3px;
            color: #00ff41;
        }

        /* èƒŒåŒ… */
        .inventory-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .inventory-item {
            padding: 6px;
            margin: 4px 0;
            background: rgba(0, 60, 0, 0.3);
            border-left: 3px solid #00ff41;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .inventory-item:hover {
            background: rgba(0, 100, 0, 0.5);
            transform: translateX(3px);
        }

        .inventory-item .item-name {
            color: #00ff41;
            font-weight: bold;
        }

        .inventory-item .item-desc {
            color: #888;
            font-size: 10px;
            margin-top: 2px;
        }

        /* ===== å°åœ°å›¾æ ·å¼ ===== */
        .minimap-box {
            background: rgba(0, 20, 0, 0.7);
            border: 1px solid #00ff41;
            border-radius: 5px;
            padding: 10px;
            min-height: 200px;
        }

        .minimap-box h3 {
            color: #00cc33;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            text-align: center;
        }

        .floor-indicator {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #ffff00;
            text-shadow: 0 0 10px #ffff00;
            margin-bottom: 8px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
        }

        .minimap-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            margin-bottom: 8px;
            min-height: 150px;
            width: 100%;
        }

        .minimap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border-radius: 3px;
            transition: all 0.2s;
            cursor: default;
            min-height: 28px;
            min-width: 28px;
        }

        .minimap-cell.unexplored {
            background: rgba(0, 0, 0, 0.6);
            color: #333;
        }

        .minimap-cell.explored {
            background: rgba(0, 60, 0, 0.4);
            border: 1px solid #004400;
        }

        .minimap-cell.current {
            background: rgba(0, 255, 65, 0.3);
            border: 2px solid #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
            animation: pulse 1.5s infinite;
        }

        .minimap-cell.entrance {
            background: rgba(100, 100, 255, 0.3);
            border: 1px solid #6666ff;
        }

        .minimap-cell.exit {
            background: rgba(255, 100, 100, 0.3);
            border: 1px solid #ff6666;
        }

        .minimap-cell.combat {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff3333;
        }

        .minimap-cell.treasure {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
        }

        .minimap-cell.stairs-up, .minimap-cell.stairs-down {
            background: rgba(139, 69, 19, 0.4);
            border: 1px solid #8b4513;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* åœ°å›¾å›¾ä¾‹ */
        .minimap-legend {
            font-size: 10px;
            color: #888;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ä¸»æ¸¸æˆåŒºåŸŸ */
        .main-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* åœºæ™¯æè¿°åŒºåŸŸ */
        .scene-panel {
            background: rgba(0, 10, 0, 0.9);
            border: 2px solid #00ff41;
            border-radius: 10px;
            padding: 25px;
            flex: 1;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.15), inset 0 0 30px rgba(0, 255, 65, 0.03);
        }

        .location-title {
            color: #00ff41;
            font-size: 28px;
            margin-bottom: 20px;
            text-shadow: 0 0 15px #00ff41;
            border-bottom: 2px solid #00ff41;
            padding-bottom: 10px;
        }

        .floor-badge {
            display: inline-block;
            background: linear-gradient(135deg, #660000, #990000);
            color: #ffff00;
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 4px;
            margin-left: 15px;
            vertical-align: middle;
            border: 1px solid #ff6600;
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.3);
        }

        .scene-description {
            color: #b3ffb3;
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        /* æ¸¸æˆæ—¥å¿— */
        .log-panel {
            background: rgba(0, 5, 0, 0.95);
            border: 1px solid #008f11;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .log-entry.info {
            background: rgba(0, 50, 100, 0.3);
            border-left: 3px solid #0088ff;
            color: #88ccff;
        }

        .log-entry.combat {
            background: rgba(100, 0, 0, 0.3);
            border-left: 3px solid #ff3333;
            color: #ff8888;
        }

        .log-entry.success {
            background: rgba(0, 100, 0, 0.3);
            border-left: 3px solid #00ff41;
            color: #88ff88;
        }

        .log-entry.loot {
            background: rgba(100, 100, 0, 0.3);
            border-left: 3px solid #ffff00;
            color: #ffff88;
        }

        .log-entry.floor-change {
            background: rgba(139, 69, 19, 0.3);
            border-left: 3px solid #ff6600;
            color: #ffaa66;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-panel {
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #00ff41;
            border-radius: 10px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .prompt {
            color: #00ff41;
            font-size: 18px;
            font-weight: bold;
            white-space: nowrap;
        }

        .command-input {
            flex: 1;
            background: rgba(0, 40, 0, 0.5);
            border: 1px solid #00ff41;
            border-radius: 5px;
            padding: 12px 15px;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            outline: none;
            transition: all 0.2s;
        }

        .command-input:focus {
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.4);
            background: rgba(0, 60, 0, 0.7);
        }

        .command-input::placeholder {
            color: #005511;
        }

        .btn {
            background: linear-gradient(180deg, #003300, #001100);
            border: 2px solid #00ff41;
            color: #00ff41;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .btn:hover {
            background: linear-gradient(180deg, #00ff41, #008f11);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        /* å¿«æ·æŒ‰é’® */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .quick-btn {
            background: rgba(0, 50, 0, 0.5);
            border: 1px solid #008f11;
            color: #00cc33;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: rgba(0, 100, 0, 0.7);
            border-color: #00ff41;
            color: #00ff41;
        }

        .quick-btn.pickup-all-btn {
            background: linear-gradient(180deg, #003300, #004400);
            border-color: #ffff00;
            color: #ffff00;
            font-weight: bold;
        }

        .quick-btn.pickup-all-btn:hover {
            background: linear-gradient(180deg, #ffff00, #cc9900);
            color: #000;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.5);
        }

        .quick-btn.stairs-btn {
            background: linear-gradient(180deg, #331100, #551100);
            border-color: #ff6600;
            color: #ffaa00;
        }

        .quick-btn.stairs-btn:hover {
            background: linear-gradient(180deg, #ff6600, #cc4400);
            color: #000;
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.5);
        }

        /* ä¿å­˜/åŠ è½½æŒ‰é’® */
        .save-controls {
            margin-top: auto;
            display: flex;
            gap: 10px;
        }

        .save-controls .btn {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d0d0d;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff41;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00cc33;
        }

        /* é—ªçƒå…‰æ ‡ */
        .cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background: #00ff41;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* å“åº”å¼ */
        @media (max-width: 900px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: auto;
                min-height: calc(100vh - 40px);
            }
            
            .sidebar {
                flex-direction: row;
                flex-wrap: wrap;
                max-height: none;
                height: auto;
            }
            
            .sidebar h2 {
                width: 100%;
            }
            
            .stat-box, .minimap-box {
                flex: 1;
                min-width: 200px;
            }
            
            .save-controls {
                width: 100%;
                margin-top: 15px;
            }
        }
        
        @media (max-width: 600px) {
            .stat-box, .minimap-box {
                min-width: 100%;
            }
        }

        /* æ ‡é¢˜åŠ¨ç”» */
        .game-title {
            text-align: center;
            font-size: 14px;
            color: #005511;
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        /* æ•Œäººæ˜¾ç¤º */
        .enemy-display {
            background: rgba(50, 0, 0, 0.3);
            border: 1px solid #ff3333;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .enemy-display.active {
            display: block;
            animation: enemyAppear 0.5s ease;
        }

        @keyframes enemyAppear {
            from { 
                opacity: 0; 
                transform: scale(0.9);
            }
            to { 
                opacity: 1; 
                transform: scale(1);
            }
        }

        .enemy-name {
            color: #ff3333;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px #ff3333;
        }

        .enemy-hp-bar {
            width: 100%;
            height: 15px;
            background: #1a0000;
            border: 1px solid #ff3333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .enemy-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #660000, #ff3333);
            transition: width 0.3s ease;
        }

        /* æ–¹å‘æŒ‰é’® */
        .directions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .dir-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 40, 0, 0.7);
            border: 2px solid #00ff41;
            color: #00ff41;
            font-size: 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .dir-btn:hover:not(:disabled) {
            background: #00ff41;
            color: #000;
        }

        .dir-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* æ¥¼å±‚è¿‡æ¸¡åŠ¨ç”» */
        .floor-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .floor-transition.active {
            opacity: 1;
            pointer-events: all;
        }

        .floor-transition-text {
            font-size: 48px;
            color: #ff6600;
            text-shadow: 0 0 20px #ff6600;
            animation: floorTextPulse 1s infinite;
        }

        .floor-transition-subtext {
            font-size: 20px;
            color: #888;
            margin-top: 20px;
        }

        @keyframes floorTextPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* è¿æ¥è·¯å¾„åŠ¨ç”» */
        .connection-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="crt-container">
        <div class="game-title">â•â•â• FORGOTTEN DUNGEON v2.0 â•â•â•</div>
        <div class="game-container">
            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar">
                <h2>ğŸ­ è§’è‰²çŠ¶æ€</h2>
                
                <div class="stat-box">
                    <h3>ğŸ“Š åŸºç¡€å±æ€§</h3>
                    <div class="stat-row">
                        <span class="stat-label">åç§°:</span>
                        <span class="stat-value" id="player-name">æ— åå†’é™©è€…</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ç­‰çº§:</span>
                        <span class="stat-value" id="player-level">1</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ç»éªŒ:</span>
                        <span class="stat-value" id="player-xp">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">é‡‘å¸:</span>
                        <span class="stat-value" id="player-gold">0</span>
                    </div>
                </div>

                <div class="stat-box">
                    <h3>â¤ï¸ ç”Ÿå‘½å€¼</h3>
                    <div class="hp-bar-container">
                        <div class="hp-bar">
                            <div class="hp-fill" id="hp-bar" style="width: 100%"></div>
                        </div>
                        <div class="hp-text"><span id="current-hp">100</span> / <span id="max-hp">100</span> HP</div>
                    </div>
                </div>

                <!-- å°åœ°å›¾åŒºåŸŸ -->
                <div class="minimap-box">
                    <h3>ğŸ—ºï¸ åœ°ç‰¢åœ°å›¾</h3>
                    <div class="floor-indicator" id="floor-indicator">åœ°é¢å±‚</div>
                    <div class="minimap-container" id="minimap-container">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="minimap-legend">
                        <div class="legend-item"><span>ğŸŸ¢</span> ä½ åœ¨è¿™é‡Œ</div>
                        <div class="legend-item"><span>â¬œ</span> å·²æ¢ç´¢</div>
                        <div class="legend-item"><span>â¬›</span> æœªæ¢ç´¢</div>
                        <div class="legend-item"><span>ğŸšª</span> å‡ºå…¥å£</div>
                        <div class="legend-item"><span>âš”ï¸</span> æ•Œäºº</div>
                        <div class="legend-item"><span>ğŸ’</span> å®è—</div>
                        <div class="legend-item"><span>â¬†ï¸</span> ä¸Šæ¥¼</div>
                        <div class="legend-item"><span>â¬‡ï¸</span> ä¸‹æ¥¼</div>
                    </div>
                </div>

                <div class="stat-box">
                    <h3>ğŸ’ èƒŒåŒ…</h3>
                    <div class="inventory-list" id="inventory-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="save-controls">
                    <button class="btn" onclick="game.saveGame()">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn" onclick="game.loadGame()">ğŸ“‚ åŠ è½½</button>
                </div>
            </aside>

            <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
            <main class="main-area">
                <!-- åœºæ™¯æè¿° -->
                <div class="scene-panel" id="scene-panel">
                    <h1 class="location-title" id="location-title">
                        ğŸšª åœ°ç‰¢å…¥å£
                        <span class="floor-badge" id="floor-badge">åœ°é¢å±‚</span>
                    </h1>
                    <div class="scene-description" id="scene-description">
                        åŠ è½½ä¸­...
                    </div>
                    
                    <!-- æ•Œäººæ˜¾ç¤º -->
                    <div class="enemy-display" id="enemy-display">
                        <div class="enemy-name" id="enemy-name">æ²¼æ³½å·¨é¼ </div>
                        <div class="enemy-hp-bar">
                            <div class="enemy-hp-fill" id="enemy-hp-bar" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- æ–¹å‘æ§åˆ¶ -->
                    <div class="directions">
                        <button class="dir-btn" id="btn-north" onclick="game.move('north')">åŒ—</button>
                        <button class="dir-btn" id="btn-south" onclick="game.move('south')">å—</button>
                        <button class="dir-btn" id="btn-east" onclick="game.move('east')">ä¸œ</button>
                        <button class="dir-btn" id="btn-west" onclick="game.move('west')">è¥¿</button>
                    </div>
                </div>

                <!-- æ¸¸æˆæ—¥å¿— -->
                <div class="log-panel" id="log-panel">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="input-panel">
                    <span class="prompt">&gt;<span class="cursor"></span></span>
                    <input type="text" class="command-input" id="command-input" placeholder="è¾“å…¥å‘½ä»¤ (å¦‚: æ”»å‡», å»ä¸œè¾¹, æ£€æŸ¥è¢‹å­...)" autocomplete="off">
                    <button class="btn" onclick="game.executeCommand()">æ‰§è¡Œ</button>
                </div>

                <!-- å¿«æ·æŒ‰é’® -->
                <div class="quick-actions">
                    <button class="quick-btn" onclick="game.quickCommand('æ£€æŸ¥')">ğŸ” æ£€æŸ¥</button>
                    <button class="quick-btn" onclick="game.quickCommand('æ”»å‡»')">âš”ï¸ æ”»å‡»</button>
                    <button class="quick-btn" onclick="game.quickCommand('èƒŒåŒ…')">ğŸ’ èƒŒåŒ…</button>
                    <button class="quick-btn" onclick="game.quickCommand('çŠ¶æ€')">ğŸ“Š çŠ¶æ€</button>
                    <button class="quick-btn" onclick="game.quickCommand('å¸®åŠ©')">â“ å¸®åŠ©</button>
                    <button class="quick-btn pickup-all-btn" id="pickup-all-btn" onclick="game.pickupAll()" style="display: none;">ğŸ“¦ ä¸€é”®æ‹¾å–</button>
                    <button class="quick-btn stairs-btn" id="stairs-up-btn" onclick="game.useStairs('up')" style="display: none;">â¬†ï¸ ä¸Šæ¥¼</button>
                    <button class="quick-btn stairs-btn" id="stairs-down-btn" onclick="game.useStairs('down')" style="display: none;">â¬‡ï¸ ä¸‹æ¥¼</button>
                </div>
            </main>
        </div>
    </div>

    <!-- æ¥¼å±‚è¿‡æ¸¡åŠ¨ç”» -->
    <div class="floor-transition" id="floor-transition">
        <div class="floor-transition-text" id="floor-transition-text">æ­£åœ¨ä¸‹æ¥¼...</div>
        <div class="floor-transition-subtext" id="floor-transition-subtext">è¿›å…¥æ›´æ·±çš„é»‘æš—...</div>
    </div>

    <script>
        // ==================== æ¸¸æˆæ•°æ® ====================
        
        // æ¥¼å±‚é…ç½®
        const FLOORS = {
            surface: { id: 'surface', name: 'åœ°é¢å±‚', level: 0, theme: 'entrance' },
            b1: { id: 'b1', name: 'åœ°ä¸‹ä¸€å±‚ (B1)', level: 1, theme: 'novice' },
            b2: { id: 'b2', name: 'åœ°ä¸‹äºŒå±‚ (B2)', level: 2, theme: 'dangerous' },
            b3: { id: 'b3', name: 'åœ°ä¸‹ä¸‰å±‚ (B3)', level: 3, theme: 'boss' }
        };

        // æˆ¿é—´æ•°æ® - æ¯ä¸ªæ¥¼å±‚ 5x5 ç½‘æ ¼
        const ROOMS = {
            // åœ°é¢å±‚
            surface_entrance: {
                id: 'surface_entrance',
                name: 'ğŸšª åœ°ç‰¢å…¥å£',
                description: 'ä½ ç«™åœ¨åœ°ç‰¢çš„å…¥å£å¤„ã€‚å¤è€çš„çŸ³é—¨æ•å¼€ç€ï¼Œé€šå¾€åœ°ä¸‹çš„é»‘æš—æ·±å¤„ã€‚ç©ºæ°”ä¸­å¼¥æ¼«ç€æ½®æ¹¿å’Œè…æœ½çš„æ°”æ¯ã€‚è¿™é‡Œä¼¼ä¹æ˜¯ä¸€ä¸ªåºŸå¼ƒå·²ä¹…çš„åœ°ä¸‹é—è¿¹å…¥å£ã€‚',
                floor: 'surface',
                x: 2, y: 0,
                exits: { south: 'surface_lobby' },
                items: [],
                enemy: null,
                type: 'entrance'
            },
            surface_lobby: {
                id: 'surface_lobby',
                name: 'ğŸ›ï¸ å‰å…',
                description: 'ä¸€ä¸ªå®½æ•çš„çŸ³åˆ¶å‰å…ï¼Œå¢™ä¸ŠæŒ‚ç€ç†„ç­å¤šå¹´çš„ç«æŠŠã€‚åœ°é¢ç”±å¤è€çš„çŸ³æ¿é“ºæˆï¼Œç¼éš™ä¸­é•¿å‡ºäº†é’è‹”ã€‚æ­£å‰æ–¹æœ‰ä¸€æ¡å‘ä¸‹çš„çŸ³é˜¶ï¼Œé€šå¾€åœ°ä¸‹ä¸€å±‚ã€‚',
                floor: 'surface',
                x: 2, y: 1,
                exits: { north: 'surface_entrance', south: 'surface_stairs_b1' },
                items: [
                    { id: 'torch', name: 'ç«æŠŠ', type: 'misc', description: 'ä¸€æ ¹è¿˜èƒ½ä½¿ç”¨çš„ç«æŠŠ' }
                ],
                enemy: null,
                type: 'normal'
            },
            surface_stairs_b1: {
                id: 'surface_stairs_b1',
                name: 'ğŸªœ é€šå¾€B1çš„æ¥¼æ¢¯',
                description: 'ä¸€æ®µå¤è€çš„çŸ³é˜¶ç›˜æ—‹è€Œä¸‹ï¼Œæ¶ˆå¤±åœ¨é»‘æš—ä¸­ã€‚æ¥¼æ¢¯æ—è¾¹çš„å¢™ä¸Šåˆ»ç€è­¦å‘Šæ–‡å­—ï¼š"è¿›å…¥è€…åæœè‡ªè´Ÿ"ã€‚ä½ å¯ä»¥ä»è¿™é‡Œä¸‹åˆ°åœ°ä¸‹ä¸€å±‚ã€‚',
                floor: 'surface',
                x: 2, y: 2,
                exits: { north: 'surface_lobby', down: 'b1_entrance' },
                items: [],
                enemy: null,
                type: 'stairs_down'
            },

            // B1 - æ–°æ‰‹åŒº
            b1_entrance: {
                id: 'b1_entrance',
                name: 'ğŸšª B1 å…¥å£å¤§å…',
                description: 'B1å±‚ - æ–°æ‰‹åŒºï¼šä½ æ¥åˆ°äº†åœ°ä¸‹ä¸€å±‚ã€‚è¿™é‡Œç›¸å¯¹å®‰å…¨ï¼Œæ˜¯å†’é™©è€…çš„è¯•ç‚¼ä¹‹åœ°ã€‚å››å‘¨ä¼ æ¥è€é¼ çš„å±å±å£°å’Œè™è çš„æ‰‘ç¿…å£°ã€‚',
                floor: 'b1',
                x: 2, y: 4,
                exits: { north: 'b1_corridor', up: 'surface_stairs_b1' },
                items: [],
                enemy: null,
                type: 'stairs_up'
            },
            b1_corridor: {
                id: 'b1_corridor',
                name: 'ğŸ€ é¼ æ‚£èµ°å»Š',
                description: 'è¿™æ¡èµ°å»Šå……æ»¡äº†è€é¼ æ´ï¼Œåœ°é¢ä¸Šæ•£è½ç€ç¢éª¨å’Œç ´å¸ƒã€‚ä½ å¬åˆ°å››å‘¨ä¼ æ¥çª¸çª¸çª£çª£çš„å£°éŸ³ï¼Œä¼¼ä¹æœ‰ä»€ä¹ˆä¸œè¥¿åœ¨æš—å¤„çª¥è§†ç€ä½ ã€‚',
                floor: 'b1',
                x: 2, y: 3,
                exits: { north: 'b1_storage', south: 'b1_entrance', east: 'b1_armory', west: 'b1_dining' },
                items: [],
                enemy: {
                    id: 'giant_rat',
                    name: 'å·¨é¼ ',
                    hp: 30,
                    maxHp: 30,
                    damage: 5,
                    xp: 10,
                    loot: [
                        { id: 'rat_tail', name: 'è€é¼ å°¾å·´', type: 'material', description: 'æ¹¿æ¼‰æ¼‰çš„å°¾å·´' }
                    ]
                },
                type: 'combat'
            },
            b1_storage: {
                id: 'b1_storage',
                name: 'ğŸ“¦ å‚¨è—å®¤',
                description: 'ä¸€ä¸ªå †æ»¡æœ¨ç®±å’Œéº»è¢‹çš„æˆ¿é—´ã€‚è™½ç„¶æœ‰äº›ç®±å­å·²ç»è¢«æ‰“å¼€ï¼Œä½†ä½ è¿˜æ˜¯å‘ç°äº†ä¸€äº›æœ‰ç”¨çš„ç‰©èµ„ã€‚',
                floor: 'b1',
                x: 2, y: 2,
                exits: { south: 'b1_corridor', east: 'b1_treasure' },
                items: [
                    { id: 'healing_potion_small', name: 'å°å‹æ²»ç–—è¯æ°´', type: 'consumable', heal: 30, quantity: 2, description: 'çº¢è‰²æ¶²ä½“åœ¨ç“¶ä¸­å¾®å¾®å‘å…‰' }
                ],
                enemy: null,
                type: 'normal'
            },
            b1_armory: {
                id: 'b1_armory',
                name: 'âš”ï¸ æ—§å†›æ¢°åº“',
                description: 'è¿™é‡Œæ›¾ç»æ˜¯å®ˆå«å­˜æ”¾æ­¦å™¨çš„åœ°æ–¹ã€‚è™½ç„¶å¤§éƒ¨åˆ†è£…å¤‡å·²ç»é”ˆèš€ï¼Œä½†ä½ å‘ç°äº†ä¸€æŠŠè¿˜èƒ½ä½¿ç”¨çš„çŸ­å‰‘ã€‚',
                floor: 'b1',
                x: 3, y: 3,
                exits: { west: 'b1_corridor', north: 'b1_bat_cave' },
                items: [
                    { id: 'short_sword', name: 'çŸ­å‰‘', type: 'weapon', damage: 8, description: 'ä¸€æŠŠé”‹åˆ©çš„çŸ­å‰‘ï¼Œæ¯”ç”Ÿé”ˆçš„åŒ•é¦–å¥½ç”¨å¤šäº†' }
                ],
                enemy: null,
                type: 'treasure'
            },
            b1_dining: {
                id: 'b1_dining',
                name: 'ğŸ– åºŸå¼ƒé¤å…',
                description: 'é•¿æ¡Œä¸Šå¸ƒæ»¡äº†ç°å°˜å’Œéœ‰èŒï¼Œæ¤…å­ä¸œå€’è¥¿æ­ªã€‚è§’è½é‡Œä¼¼ä¹æœ‰ä»€ä¹ˆä¸œè¥¿åœ¨ç§»åŠ¨...',
                floor: 'b1',
                x: 1, y: 3,
                exits: { east: 'b1_corridor' },
                items: [
                    { id: 'stale_bread', name: 'å‘éœ‰é¢åŒ…', type: 'consumable', heal: 15, quantity: 1, description: 'è™½ç„¶ä¸å¤ªæ–°é²œï¼Œä½†è¿˜èƒ½åƒ' }
                ],
                enemy: {
                    id: 'cave_bat',
                    name: 'æ´ç©´è™è ',
                    hp: 25,
                    maxHp: 25,
                    damage: 4,
                    xp: 8,
                    loot: [
                        { id: 'bat_wing', name: 'è™è ç¿…è†€', type: 'material', description: 'è–„è–„çš„è™è ç¿…è†€' }
                    ]
                },
                type: 'combat'
            },
            b1_treasure: {
                id: 'b1_treasure',
                name: 'ğŸ’ ç§˜å¯†è—å®å®¤',
                description: 'ä½ å‘ç°äº†ä¸€ä¸ªéšè—çš„å°æˆ¿é—´ï¼è¿™é‡Œå †æ”¾ç€ä¸€äº›å†’é™©è€…ç•™ä¸‹çš„è¡¥ç»™å“ã€‚è§’è½é‡Œè¿˜æœ‰ä¸€å¼ é€šå¾€æ›´æ·±å±‚çš„åœ°å›¾ã€‚',
                floor: 'b1',
                x: 3, y: 2,
                exits: { west: 'b1_storage', south: 'b1_stairs_b2' },
                items: [
                    { id: 'healing_potion', name: 'æ²»ç–—è¯æ°´', type: 'consumable', heal: 50, quantity: 1, description: 'æ¢å¤æ›´å¤šç”Ÿå‘½å€¼çš„è¯æ°´' },
                    { id: 'gold_coins', name: 'é‡‘å¸è¢‹', type: 'misc', description: 'ä¸€è¢‹é—ªé—ªå‘å…‰çš„é‡‘å¸', value: 50 }
                ],
                enemy: null,
                type: 'treasure'
            },
            b1_bat_cave: {
                id: 'b1_bat_cave',
                name: 'ğŸ¦‡ è™è æ´çªŸ',
                description: 'æ´é¡¶æŒ‚æ»¡äº†å€’æŒ‚çš„è™è ã€‚ä½ çš„åˆ°æ¥æƒŠæ‰°äº†å®ƒä»¬ï¼ä¸€ç¾¤è™è æœä½ æ‰‘æ¥ã€‚',
                floor: 'b1',
                x: 3, y: 4,
                exits: { south: 'b1_armory' },
                items: [],
                enemy: {
                    id: 'bat_swarm',
                    name: 'è™è ç¾¤',
                    hp: 40,
                    maxHp: 40,
                    damage: 6,
                    xp: 15,
                    loot: [
                        { id: 'bat_wing', name: 'è™è ç¿…è†€', type: 'material', description: 'è–„è–„çš„è™è ç¿…è†€' }
                    ]
                },
                type: 'combat'
            },
            b1_stairs_b2: {
                id: 'b1_stairs_b2',
                name: 'ğŸªœ é€šå¾€B2çš„æ¥¼æ¢¯',
                description: 'å‘ä¸‹çš„æ¥¼æ¢¯æ¯”B1çš„æ›´åŠ ç ´æ—§ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€è…æœ½å’Œæ­»äº¡çš„æ°”æ¯ã€‚ä¸‹å»åå°†è¿›å…¥æ›´åŠ å±é™©çš„åŒºåŸŸã€‚',
                floor: 'b1',
                x: 3, y: 1,
                exits: { north: 'b1_treasure', down: 'b2_entrance' },
                items: [],
                enemy: null,
                type: 'stairs_down'
            },

            // B2 - å±é™©åŒº
            b2_entrance: {
                id: 'b2_entrance',
                name: 'âš ï¸ B2 å±é™©åŒºå…¥å£',
                description: 'B2å±‚ - å±é™©åŒºï¼šç©ºæ°”å˜å¾—æ›´åŠ é˜´å†·ï¼Œå¢™å£ä¸Šæ¸—å‡ºäº†æ°´ç ã€‚ä½ å¬åˆ°è¿œå¤„ä¼ æ¥çš„éª¨éª¼ç¢°æ’å£°å’Œé‡‘å±æ‘©æ“¦å£°ã€‚è¿™é‡Œæ˜æ˜¾æ¯”B1å±é™©å¾—å¤šã€‚',
                floor: 'b2',
                x: 2, y: 4,
                exits: { north: 'b2_skeleton_hall', up: 'b1_stairs_b2' },
                items: [],
                enemy: null,
                type: 'stairs_up'
            },
            b2_skeleton_hall: {
                id: 'b2_skeleton_hall',
                name: 'ğŸ’€ éª·é«…å¤§å…',
                description: 'å¤§å…ä¸­æ•£è½ç€è®¸å¤šéª¸éª¨ï¼Œå…¶ä¸­ä¸€äº›ä¼¼ä¹è¿˜åœ¨å¾®å¾®é¢¤åŠ¨ã€‚çªç„¶ï¼Œä¸€å…·éª·é«…ä»åœ°ä¸Šç«™äº†èµ·æ¥ï¼',
                floor: 'b2',
                x: 2, y: 3,
                exits: { south: 'b2_entrance', east: 'b2_trap_room', west: 'b2_armory', north: 'b2_crossroads' },
                items: [],
                enemy: {
                    id: 'skeleton_warrior',
                    name: 'éª·é«…æˆ˜å£«',
                    hp: 60,
                    maxHp: 60,
                    damage: 12,
                    xp: 25,
                    loot: [
                        { id: 'bone_fragment', name: 'éª¨ç‰‡', type: 'material', description: 'ä¸€å—å®Œæ•´çš„éª¨å¤´' },
                        { id: 'rusty_sword', name: 'é”ˆèš€é•¿å‰‘', type: 'weapon', damage: 10, description: 'ä¸€æŠŠç”Ÿé”ˆä½†ä»ç„¶å¯ç”¨çš„é•¿å‰‘' }
                    ]
                },
                type: 'combat'
            },
            b2_trap_room: {
                id: 'b2_trap_room',
                name: 'â›“ï¸ é™·é˜±å®¤',
                description: 'è¿™ä¸ªæˆ¿é—´çš„åœ°é¢ä¸Šå¸ƒæ»¡äº†æœºå…³å’Œé™·é˜±çš„ç—•è¿¹ã€‚è™½ç„¶å¤§éƒ¨åˆ†å·²ç»å¤±æ•ˆï¼Œä½†ä½ ä»éœ€è¦å°å¿ƒã€‚åœ¨æˆ¿é—´æ·±å¤„ï¼Œä½ å‘ç°äº†è¢«å›°ä½çš„å®ç®±ã€‚',
                floor: 'b2',
                x: 3, y: 3,
                exits: { west: 'b2_skeleton_hall', north: 'b2_dark_chamber' },
                items: [
                    { id: 'healing_potion_medium', name: 'ä¸­å‹æ²»ç–—è¯æ°´', type: 'consumable', heal: 70, quantity: 1, description: 'æ›´å¼ºæ•ˆçš„æ²»ç–—è¯æ°´' }
                ],
                enemy: {
                    id: 'spike_trap',
                    name: 'å°–åˆºé™·é˜±æ€ª',
                    hp: 45,
                    maxHp: 45,
                    damage: 15,
                    xp: 20,
                    loot: [
                        { id: 'trap_mechanism', name: 'é™·é˜±é›¶ä»¶', type: 'material', description: 'å¯ä»¥ç”¨æ¥åˆ¶ä½œé™·é˜±çš„é›¶ä»¶' }
                    ]
                },
                type: 'combat'
            },
            b2_armory: {
                id: 'b2_armory',
                name: 'ğŸ›¡ï¸ é‡è£…å†›æ¢°åº“',
                description: 'è¿™é‡Œå­˜æ”¾ç€æ›´é«˜çº§çš„è£…å¤‡ã€‚è™½ç„¶å¤§éƒ¨åˆ†å·²ç»æŸåï¼Œä½†ä½ å‘ç°äº†ä¸€å¥—çš®ç”²å’Œä¸€æŠŠæ›´å¥½çš„æ­¦å™¨ã€‚',
                floor: 'b2',
                x: 1, y: 3,
                exits: { east: 'b2_skeleton_hall', north: 'b2_prison' },
                items: [
                    { id: 'leather_armor', name: 'çš®ç”²', type: 'armor', defense: 5, description: 'æä¾›é¢å¤–é˜²æŠ¤çš„çš®ç”²' },
                    { id: 'iron_dagger', name: 'é“åŒ•é¦–', type: 'weapon', damage: 12, description: 'é”‹åˆ©çš„é“åˆ¶åŒ•é¦–' }
                ],
                enemy: null,
                type: 'treasure'
            },
            b2_crossroads: {
                id: 'b2_crossroads',
                name: 'ğŸ”€ åå­—å²”è·¯',
                description: 'å››æ¡é€šé“åœ¨è¿™é‡Œäº¤æ±‡ã€‚ä½ é€‰æ‹©äº†ä¸€æ¡è·¯å‰è¿›ï¼Œä½†æ— è®ºå“ªæ¡è·¯éƒ½å……æ»¡äº†å±é™©ã€‚',
                floor: 'b2',
                x: 2, y: 2,
                exits: { south: 'b2_skeleton_hall', east: 'b2_skeleton_king', west: 'b2_secret_room', north: 'b2_stairs_b3' },
                items: [],
                enemy: {
                    id: 'undead_guard',
                    name: 'äº¡çµå®ˆå«',
                    hp: 70,
                    maxHp: 70,
                    damage: 14,
                    xp: 30,
                    loot: [
                        { id: 'guard_helmet', name: 'å®ˆå«å¤´ç›”', type: 'armor', defense: 8, description: 'äº¡çµå®ˆå«çš„å¤´ç›”' }
                    ]
                },
                type: 'combat'
            },
            b2_skeleton_king: {
                id: 'b2_skeleton_king',
                name: 'ğŸ‘‘ éª·é«…ç‹åº§å®¤',
                description: 'ä¸€ä¸ªå·¨å¤§çš„éª·é«…ååœ¨çŸ³åˆ¶ç‹åº§ä¸Šï¼Œç©ºæ´çš„çœ¼çœ¶ä¸­é—ªçƒç€çº¢è‰²çš„å…‰èŠ’ã€‚è¿™æ˜¯éª·é«…ç‹ï¼',
                floor: 'b2',
                x: 3, y: 2,
                exits: { west: 'b2_crossroads' },
                items: [
                    { id: 'crown_of_bones', name: 'éª¨å† ', type: 'misc', description: 'éª·é«…ç‹çš„ç‹å† ï¼Œå¾ˆæœ‰æ”¶è—ä»·å€¼' },
                    { id: 'large_healing_potion', name: 'å¤§å‹æ²»ç–—è¯æ°´', type: 'consumable', heal: 100, quantity: 1, description: 'èƒ½æ¢å¤å¤§é‡ç”Ÿå‘½å€¼' }
                ],
                enemy: {
                    id: 'skeleton_king',
                    name: 'éª·é«…ç‹',
                    hp: 120,
                    maxHp: 120,
                    damage: 18,
                    xp: 80,
                    loot: [
                        { id: 'bone_sword', name: 'éª¨å‰‘', type: 'weapon', damage: 20, description: 'ç”¨å¼ºå¤§äº¡çµçš„éª¨å¤´åˆ¶æˆçš„å‰‘' }
                    ]
                },
                type: 'combat'
            },
            b2_secret_room: {
                id: 'b2_secret_room',
                name: 'ğŸ”® ç¥ç§˜å¯†å®¤',
                description: 'ä½ å‘ç°äº†ä¸€ä¸ªéšè—çš„å¯†å®¤ï¼Œé‡Œé¢å­˜æ”¾ç€å¤è€çš„å·è½´å’Œç¥ç§˜çš„ç‰©å“ã€‚ç©ºæ°”ä¸­å……æ»¡äº†é­”æ³•çš„æ°”æ¯ã€‚',
                floor: 'b2',
                x: 1, y: 2,
                exits: { east: 'b2_crossroads' },
                items: [
                    { id: 'magic_scroll', name: 'é­”æ³•å·è½´', type: 'consumable', description: 'åŒ…å«ç¥ç§˜åŠ›é‡çš„å·è½´', effect: 'random' },
                    { id: 'mana_potion', name: 'é­”åŠ›è¯æ°´', type: 'consumable', heal: 50, quantity: 1, description: 'æ¢å¤ç”Ÿå‘½å’Œé­”åŠ›' }
                ],
                enemy: null,
                type: 'treasure'
            },
            b2_prison: {
                id: 'b2_prison',
                name: 'â›“ï¸ åœ°ç‰¢ç›‘ç‹±',
                description: 'ç”Ÿé”ˆçš„é“æ …æ å’Œé”é“¾éå¸ƒè¿™ä¸ªæˆ¿é—´ã€‚è¿™é‡Œæ›¾ç»å…³æŠ¼ç€å›šçŠ¯ï¼Œç°åœ¨åªå‰©ä¸‹æ€¨çµåœ¨å¾˜å¾Šã€‚',
                floor: 'b2',
                x: 1, y: 4,
                exits: { south: 'b2_armory' },
                items: [
                    { id: 'prison_key', name: 'ç›‘ç‹±é’¥åŒ™', type: 'key', description: 'å¯ä»¥æ‰“å¼€æŸäº›é”ä½çš„é—¨' }
                ],
                enemy: {
                    id: 'ghost_prisoner',
                    name: 'å›šçŠ¯æ€¨çµ',
                    hp: 55,
                    maxHp: 55,
                    damage: 10,
                    xp: 35,
                    loot: [
                        { id: 'ectoplasm', name: 'çµè´¨', type: 'material', description: 'å¹½çµç•™ä¸‹çš„ç‰©è´¨' }
                    ]
                },
                type: 'combat'
            },
            b2_dark_chamber: {
                id: 'b2_dark_chamber',
                name: 'ğŸŒ‘ é»‘æš—å¯†å®¤',
                description: 'å‡ ä¹å®Œå…¨é»‘æš—çš„æˆ¿é—´ã€‚ä½ åªèƒ½å¬åˆ°è‡ªå·±çš„å¿ƒè·³å£°å’Œè¿œå¤„ä¼ æ¥çš„è¯¡å¼‚å£°éŸ³ã€‚',
                floor: 'b2',
                x: 3, y: 4,
                exits: { south: 'b2_trap_room' },
                items: [],
                enemy: {
                    id: 'shadow_beast',
                    name: 'æš—å½±å…½',
                    hp: 80,
                    maxHp: 80,
                    damage: 16,
                    xp: 45,
                    loot: [
                        { id: 'shadow_essence', name: 'æš—å½±ç²¾å', type: 'material', description: 'é»‘æš—çš„ç»“æ™¶' }
                    ]
                },
                type: 'combat'
            },
            b2_stairs_b3: {
                id: 'b2_stairs_b3',
                name: 'ğŸªœ é€šå¾€B3çš„æ¥¼æ¢¯',
                description: 'æ¥¼æ¢¯å˜å¾—å¼‚å¸¸é™¡å³­å’Œå±é™©ï¼Œå¢™å£ä¸Šçš„ç¬¦æ–‡å‘å‡ºè¯¡å¼‚çš„çº¢å…‰ã€‚ä¼ è¯´B3å±‚å°å°ç€å¤ä»£æ¶é­”...',
                floor: 'b2',
                x: 2, y: 1,
                exits: { south: 'b2_crossroads', down: 'b3_entrance' },
                items: [],
                enemy: null,
                type: 'stairs_down'
            },

            // B3 - BossåŒº
            b3_entrance: {
                id: 'b3_entrance',
                name: 'ğŸ”¥ B3 BossåŒºå…¥å£',
                description: 'B3å±‚ - BossåŒºï¼šæ¸©åº¦æ€¥å‰§ä¸Šå‡ï¼Œç©ºæ°”ä¸­å……æ»¡äº†ç¡«ç£ºçš„å‘³é“ã€‚å¢™å£ä¸Šçš„ç¬¦æ–‡å‘å‡ºä¸ç¥¥çš„çº¢å…‰ï¼Œåœ°é¢å¼€å§‹éœ‡åŠ¨ã€‚æœ€å±é™©çš„æŒ‘æˆ˜å°±åœ¨å‰æ–¹ï¼',
                floor: 'b3',
                x: 2, y: 4,
                exits: { north: 'b3_hell_chamber', up: 'b2_stairs_b3' },
                items: [],
                enemy: null,
                type: 'stairs_up'
            },
            b3_hell_chamber: {
                id: 'b3_hell_chamber',
                name: 'ğŸ”¥ åœ°ç‹±ç†”ç‚‰',
                description: 'åœ°é¢è£‚å¼€ï¼Œå²©æµ†åœ¨ä¸‹é¢æµæ·Œã€‚è¿™é‡Œæ›¾æ˜¯å¬å”¤æ¶é­”çš„ç¥­å›ï¼Œç©ºæ°”ä¸­å……æ»¡äº†é‚ªæ¶çš„èƒ½é‡ã€‚',
                floor: 'b3',
                x: 2, y: 3,
                exits: { south: 'b3_entrance', east: 'b3_flame_guard', west: 'b3_demon_altar', north: 'b3_boss_room' },
                items: [],
                enemy: {
                    id: 'fire_imp',
                    name: 'ç«ç„°å°æ¶é­”',
                    hp: 100,
                    maxHp: 100,
                    damage: 20,
                    xp: 50,
                    loot: [
                        { id: 'fire_essence', name: 'ç«ç„°ç²¾å', type: 'material', description: 'ç‡ƒçƒ§çš„ç²¾å' }
                    ]
                },
                type: 'combat'
            },
            b3_flame_guard: {
                id: 'b3_flame_guard',
                name: 'ğŸ”¥ çƒˆç„°å®ˆå«å®¤',
                description: 'ä¸€ä¸ªå…¨èº«ç‡ƒçƒ§çš„å®ˆå«çŸ—ç«‹åœ¨è¿™ä¸ªæˆ¿é—´çš„ä¸­å¤®ï¼Œå®ƒæ‰‹ä¸­çš„ç«ç„°ä¹‹å‰‘å‘å‡ºåˆºçœ¼çš„å…‰èŠ’ã€‚',
                floor: 'b3',
                x: 3, y: 3,
                exits: { west: 'b3_hell_chamber' },
                items: [
                    { id: 'legendary_potion', name: 'ä¼ è¯´è¯æ°´', type: 'consumable', heal: 150, quantity: 1, description: 'èƒ½æ¢å¤å¤§é‡ç”Ÿå‘½å€¼çš„ç¥è¯' }
                ],
                enemy: {
                    id: 'flame_guard',
                    name: 'çƒˆç„°å®ˆå«',
                    hp: 150,
                    maxHp: 150,
                    damage: 25,
                    xp: 100,
                    loot: [
                        { id: 'flame_sword', name: 'çƒˆç„°ä¹‹å‰‘', type: 'weapon', damage: 35, description: 'ç‡ƒçƒ§ç€æ°¸æ’ç«ç„°çš„å‰‘' }
                    ]
                },
                type: 'combat'
            },
            b3_demon_altar: {
                id: 'b3_demon_altar',
                name: 'â›§ æ¶é­”ç¥­å›',
                description: 'ä¸€ä¸ªç”¨é»‘æ›œçŸ³åˆ¶æˆçš„ç¥­å›ï¼Œä¸Šé¢åˆ»æ»¡äº†ç¦å¿Œçš„ç¬¦æ–‡ã€‚ç¥­å›ä¸­å¤®æ¼‚æµ®ç€ä¸€é¢—é»‘æš—çš„æ°´æ™¶ã€‚',
                floor: 'b3',
                x: 1, y: 3,
                exits: { east: 'b3_hell_chamber' },
                items: [
                    { id: 'dark_crystal', name: 'é»‘æš—æ°´æ™¶', type: 'misc', description: 'è•´å«å¼ºå¤§é»‘æš—åŠ›é‡çš„æ°´æ™¶', value: 500 }
                ],
                enemy: {
                    id: 'cultist',
                    name: 'é‚ªæ•™å¾’',
                    hp: 80,
                    maxHp: 80,
                    damage: 18,
                    xp: 60,
                    loot: [
                        { id: 'cultist_robe', name: 'é‚ªæ•™é•¿è¢', type: 'armor', defense: 12, description: 'èƒ½å¢å¼ºé­”æ³•é˜²å¾¡çš„é•¿è¢' }
                    ]
                },
                type: 'combat'
            },
            b3_boss_room: {
                id: 'b3_boss_room',
                name: 'ğŸ‘¹ æ·±æ¸Šé¢†ä¸»æ®¿å ‚',
                description: 'è¿™é‡Œæ˜¯ä¸€åˆ‡é‚ªæ¶çš„æºå¤´ï¼å·¨å¤§çš„æ·±æ¸Šé¢†ä¸»é˜¿å…¹è«ä¸¹çŸ—ç«‹åœ¨ä½ çš„é¢å‰ã€‚å®ƒçš„ä½“å‹å æ®äº†åŠä¸ªæˆ¿é—´ï¼Œçº¢è‰²çš„çœ¼ç›æ­»æ­»ç›¯ç€ä½ ã€‚è¿™æ˜¯æœ€ç»ˆçš„å†³æˆ˜ï¼',
                floor: 'b3',
                x: 2, y: 2,
                exits: { south: 'b3_hell_chamber' },
                items: [
                    { id: 'victory_trophy', name: 'èƒœåˆ©å¥–æ¯', type: 'misc', description: 'è¯æ˜ä½ å‡»è´¥äº†æ·±æ¸Šé¢†ä¸»çš„å¥–æ¯' }
                ],
                enemy: {
                    id: 'azmodan',
                    name: 'æ·±æ¸Šé¢†ä¸»é˜¿å…¹è«ä¸¹',
                    hp: 300,
                    maxHp: 300,
                    damage: 35,
                    xp: 500,
                    loot: [
                        { id: 'azmodan_heart', name: 'æ·±æ¸Šä¹‹å¿ƒ', type: 'misc', description: 'æ·±æ¸Šé¢†ä¸»çš„æ ¸å¿ƒï¼Œä¼ è¯´ä¸­çš„å®ç‰©' },
                        { id: 'doom_bringer', name: 'æ¯ç­è€…', type: 'weapon', damage: 50, description: 'æ·±æ¸Šé¢†ä¸»ä½¿ç”¨çš„æ­¦å™¨' }
                    ]
                },
                type: 'combat'
            }
        };

        // ==================== æ¸¸æˆç±» ====================
        class ForgottenDungeon {
            constructor() {
                this.player = {
                    name: 'æ— åå†’é™©è€…',
                    level: 1,
                    hp: 100,
                    maxHp: 100,
                    xp: 0,
                    xpToNext: 100,
                    gold: 10,
                    inventory: [
                        { id: 'rusty_dagger', name: 'ç”Ÿé”ˆçš„åŒ•é¦–', type: 'weapon', damage: 5, description: 'ä¸€æŠŠé”ˆè¿¹æ–‘æ–‘çš„åŒ•é¦–ï¼Œä½†æ€»æ¯”ç©ºæ‰‹å¼º' },
                        { id: 'healing_potion_small', name: 'å°å‹æ²»ç–—è¯æ°´', type: 'consumable', heal: 30, quantity: 2, description: 'çº¢è‰²æ¶²ä½“åœ¨ç“¶ä¸­å¾®å¾®å‘å…‰' }
                    ]
                };
                this.currentLocation = 'surface_entrance';
                this.currentFloor = 'surface';
                
                // å·²æ¢ç´¢çš„æˆ¿é—´ (æ¯ä¸ªæˆ¿é—´ID)
                this.exploredRooms = ['surface_entrance'];
                
                // æ¯ä¸ªæ¥¼å±‚çš„å·²æ¢ç´¢åœ°å›¾çŠ¶æ€ (5x5 ç½‘æ ¼)
                this.floorExploration = {
                    surface: this.createEmptyGrid(),
                    b1: this.createEmptyGrid(),
                    b2: this.createEmptyGrid(),
                    b3: this.createEmptyGrid()
                };
                
                // æ ‡è®°åˆå§‹ä½ç½®ä¸ºå·²æ¢ç´¢
                this.markRoomExplored('surface_entrance');
                
                this.flags = {};
                this.logs = [];
                this.currentEnemy = null;
                this.inCombat = false;
                
                this.init();
            }

            // åˆ›å»ºç©ºçš„5x5ç½‘æ ¼
            createEmptyGrid() {
                return Array(5).fill(null).map(() => Array(5).fill(false));
            }

            // æ ‡è®°æˆ¿é—´ä¸ºå·²æ¢ç´¢
            markRoomExplored(roomId) {
                if (!this.exploredRooms.includes(roomId)) {
                    this.exploredRooms.push(roomId);
                }
                const room = ROOMS[roomId];
                if (room && room.x !== undefined && room.y !== undefined) {
                    this.floorExploration[room.floor][room.y][room.x] = true;
                }
            }

            init() {
                this.updateUI();
                this.addLog('æ¬¢è¿æ¥åˆ°é—å¿˜åœ°ç‰¢ v2.0ï¼', 'success');
                this.addLog('ä½ ç°åœ¨çš„ä½ç½®æ˜¯åœ°ç‰¢å…¥å£ã€‚æ¢ç´¢åœ°å›¾ï¼Œå¯»æ‰¾å®è—ï¼Œå°å¿ƒæ•Œäººï¼', 'info');
                this.addLog('è¾“å…¥"å¸®åŠ©"æŸ¥çœ‹å¯ç”¨å‘½ä»¤ã€‚', 'info');
                this.renderScene();
                this.updatePickupButton();
                this.updateStairsButtons();
                
                // ç»‘å®šå›è½¦é”®
                document.getElementById('command-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.executeCommand();
                    }
                });

                // ç»‘å®šé”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT') return;
                    
                    switch(e.key.toLowerCase()) {
                        case 'p':
                            this.pickupAll();
                            break;
                        case 'arrowup':
                        case 'w':
                            this.move('north');
                            break;
                        case 'arrowdown':
                        case 's':
                            this.move('south');
                            break;
                        case 'arrowleft':
                        case 'a':
                            this.move('west');
                            break;
                        case 'arrowright':
                        case 'd':
                            this.move('east');
                            break;
                    }
                });
            }

            renderScene() {
                const location = ROOMS[this.currentLocation];
                const floor = FLOORS[location.floor];
                
                document.getElementById('location-title').innerHTML = 
                    `${location.name}<span class="floor-badge">${floor.name}</span>`;
                document.getElementById('scene-description').textContent = location.description;
                document.getElementById('floor-indicator').textContent = floor.name;
                
                // æ›´æ–°æ–¹å‘æŒ‰é’®
                const directions = ['north', 'south', 'east', 'west'];
                directions.forEach(dir => {
                    const btn = document.getElementById(`btn-${dir}`);
                    if (location.exits[dir]) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    } else {
                        btn.disabled = true;
                        btn.style.opacity = '0.3';
                    }
                });

                // æ£€æŸ¥æ•Œäºº
                if (location.enemy && !this.flags[`defeated_${location.enemy.id}_${this.currentLocation}`]) {
                    this.startCombat(location.enemy);
                } else {
                    this.endCombat();
                }
                
                this.updatePickupButton();
                this.updateStairsButtons();
                this.renderMiniMap();
            }

            // æ¸²æŸ“å°åœ°å›¾
            renderMiniMap() {
                const container = document.getElementById('minimap-container');
                const currentRoom = ROOMS[this.currentLocation];
                const currentFloorRooms = Object.values(ROOMS).filter(r => r.floor === this.currentFloor);
                
                let html = '';
                
                for (let y = 0; y < 5; y++) {
                    for (let x = 0; x < 5; x++) {
                        // æ‰¾åˆ°è¿™ä¸ªä½ç½®çš„æˆ¿é—´
                        const room = currentFloorRooms.find(r => r.x === x && r.y === y);
                        const isExplored = this.floorExploration[this.currentFloor][y][x];
                        const isCurrent = currentRoom.x === x && currentRoom.y === y;
                        
                        let cellClass = 'minimap-cell';
                        let icon = 'â¬›';
                        
                        if (isCurrent) {
                            cellClass += ' current';
                            icon = 'ğŸŸ¢';
                        } else if (isExplored && room) {
                            cellClass += ' explored';
                            // æ ¹æ®æˆ¿é—´ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
                            if (room.type === 'entrance' || room.type === 'stairs_up') {
                                cellClass += ' entrance';
                                icon = 'ğŸšª';
                            } else if (room.type === 'stairs_down') {
                                cellClass += ' exit';
                                icon = 'â¬‡ï¸';
                            } else if (room.type === 'combat' && !this.flags[`defeated_${room.enemy?.id}_${room.id}`]) {
                                cellClass += ' combat';
                                icon = 'âš”ï¸';
                            } else if (room.type === 'treasure') {
                                cellClass += ' treasure';
                                icon = 'ğŸ’';
                            } else {
                                icon = 'â¬œ';
                            }
                        } else if (!isExplored) {
                            cellClass += ' unexplored';
                            icon = 'â¬›';
                        }
                        
                        html += `<div class="${cellClass}">${icon}</div>`;
                    }
                }
                
                container.innerHTML = html;
            }

            startCombat(enemy) {
                this.currentEnemy = { ...enemy, currentHp: enemy.hp };
                this.inCombat = true;
                
                const enemyDisplay = document.getElementById('enemy-display');
                enemyDisplay.classList.add('active');
                document.getElementById('enemy-name').textContent = `âš”ï¸ ${enemy.name}`;
                this.updateEnemyHp();
                
                this.addLog(`é­é‡äº† ${enemy.name}ï¼æˆ˜æ–—å¼€å§‹ï¼`, 'combat');
            }

            endCombat() {
                this.currentEnemy = null;
                this.inCombat = false;
                document.getElementById('enemy-display').classList.remove('active');
            }

            updateEnemyHp() {
                if (this.currentEnemy) {
                    const percent = (this.currentEnemy.currentHp / this.currentEnemy.maxHp) * 100;
                    document.getElementById('enemy-hp-bar').style.width = `${percent}%`;
                }
            }

            move(direction) {
                const location = ROOMS[this.currentLocation];
                const newLocationId = location.exits[direction];
                
                if (newLocationId) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥¼æ¢¯
                    if (newLocationId === 'down' || newLocationId === 'up') {
                        this.addLog('è¯·ä½¿ç”¨æ¥¼æ¢¯æŒ‰é’®ä¸Šä¸‹æ¥¼å±‚ã€‚', 'info');
                        return;
                    }
                    
                    if (this.inCombat) {
                        this.addLog('æˆ˜æ–—ä¸­æ— æ³•ç§»åŠ¨ï¼', 'combat');
                        return;
                    }
                    
                    const newRoom = ROOMS[newLocationId];
                    const oldFloor = this.currentFloor;
                    
                    this.currentLocation = newLocationId;
                    this.currentFloor = newRoom.floor;
                    
                    // æ ‡è®°æ–°æˆ¿é—´ä¸ºå·²æ¢ç´¢
                    this.markRoomExplored(newLocationId);
                    
                    this.addLog(`ä½ å‘${this.getDirectionName(direction)}ç§»åŠ¨...`, 'info');
                    
                    // å¦‚æœæ¢æ¥¼å±‚äº†ï¼Œæ˜¾ç¤ºç‰¹æ®Šæ¶ˆæ¯
                    if (oldFloor !== this.currentFloor) {
                        const floor = FLOORS[this.currentFloor];
                        this.addLog(`è¿›å…¥äº† ${floor.name}ï¼`, 'floor-change');
                    }
                    
                    this.renderScene();
                } else {
                    this.addLog('é‚£ä¸ªæ–¹å‘æ²¡æœ‰è·¯ã€‚', 'info');
                }
            }

            useStairs(direction) {
                const location = ROOMS[this.currentLocation];
                
                if (this.inCombat) {
                    this.addLog('æˆ˜æ–—ä¸­æ— æ³•ä½¿ç”¨æ¥¼æ¢¯ï¼', 'combat');
                    return;
                }
                
                const targetRoomId = location.exits[direction];
                if (!targetRoomId || (targetRoomId !== 'down' && targetRoomId !== 'up' && !ROOMS[targetRoomId])) {
                    this.addLog(`è¿™é‡Œæ²¡æœ‰${direction === 'up' ? 'ä¸Š' : 'ä¸‹'}æ¥¼çš„æ¥¼æ¢¯ã€‚`, 'info');
                    return;
                }
                
                // æ˜¾ç¤ºè¿‡æ¸¡åŠ¨ç”»
                this.showFloorTransition(direction, () => {
                    let newRoomId;
                    if (targetRoomId === 'down' || targetRoomId === 'up') {
                        // æŸ¥æ‰¾å¯¹åº”æ¥¼å±‚çš„ç›®æ ‡æˆ¿é—´
                        const currentRoom = ROOMS[this.currentLocation];
                        const targetFloor = direction === 'up' ? 
                            this.getPreviousFloor(currentRoom.floor) : 
                            this.getNextFloor(currentRoom.floor);
                        
                        // æ‰¾åˆ°ç›®æ ‡æ¥¼å±‚å¯¹åº”çš„æ¥¼æ¢¯æˆ¿é—´
                        const targetRooms = Object.values(ROOMS).filter(r => 
                            r.floor === targetFloor && 
                            r.type === (direction === 'up' ? 'stairs_down' : 'stairs_up')
                        );
                        
                        if (targetRooms.length > 0) {
                            newRoomId = targetRooms[0].id;
                        }
                    } else {
                        newRoomId = targetRoomId;
                    }
                    
                    if (newRoomId && ROOMS[newRoomId]) {
                        const oldFloor = this.currentFloor;
                        this.currentLocation = newRoomId;
                        this.currentFloor = ROOMS[newRoomId].floor;
                        this.markRoomExplored(newRoomId);
                        
                        const floor = FLOORS[this.currentFloor];
                        this.addLog(`${direction === 'up' ? 'ä¸Šæ¥¼' : 'ä¸‹æ¥¼'}æ¥åˆ°äº† ${floor.name}ï¼`, 'floor-change');
                        
                        this.renderScene();
                        this.updateUI();
                    }
                });
            }

            getNextFloor(currentFloor) {
                const order = ['surface', 'b1', 'b2', 'b3'];
                const index = order.indexOf(currentFloor);
                return index < order.length - 1 ? order[index + 1] : null;
            }

            getPreviousFloor(currentFloor) {
                const order = ['surface', 'b1', 'b2', 'b3'];
                const index = order.indexOf(currentFloor);
                return index > 0 ? order[index - 1] : null;
            }

            showFloorTransition(direction, callback) {
                const transition = document.getElementById('floor-transition');
                const text = document.getElementById('floor-transition-text');
                const subtext = document.getElementById('floor-transition-subtext');
                
                if (direction === 'up') {
                    text.textContent = 'æ­£åœ¨ä¸Šæ¥¼...';
                    subtext.textContent = 'å›åˆ°æ›´å®‰å…¨çš„åŒºåŸŸ...';
                } else {
                    text.textContent = 'æ­£åœ¨ä¸‹æ¥¼...';
                    subtext.textContent = 'è¿›å…¥æ›´æ·±çš„é»‘æš—...';
                }
                
                transition.classList.add('active');
                
                setTimeout(() => {
                    callback();
                    setTimeout(() => {
                        transition.classList.remove('active');
                    }, 300);
                }, 800);
            }

            getDirectionName(dir) {
                const names = { north: 'åŒ—', south: 'å—', east: 'ä¸œ', west: 'è¥¿' };
                return names[dir] || dir;
            }

            executeCommand() {
                const input = document.getElementById('command-input');
                const command = input.value.trim();
                
                if (!command) return;
                
                input.value = '';
                this.processCommand(command);
            }

            quickCommand(cmd) {
                document.getElementById('command-input').value = cmd;
                this.executeCommand();
            }

            processCommand(command) {
                const cmd = command.toLowerCase();
                
                // ç§»åŠ¨å‘½ä»¤
                if (cmd.includes('åŒ—') || cmd.includes('north') || cmd.includes('ä¸Š')) {
                    this.move('north');
                    return;
                }
                if (cmd.includes('å—') || cmd.includes('south') || cmd.includes('ä¸‹')) {
                    this.move('south');
                    return;
                }
                if (cmd.includes('ä¸œ') || cmd.includes('east') || cmd.includes('å³')) {
                    this.move('east');
                    return;
                }
                if (cmd.includes('è¥¿') || cmd.includes('west') || cmd.includes('å·¦')) {
                    this.move('west');
                    return;
                }

                // æ¥¼æ¢¯å‘½ä»¤
                if (cmd.includes('ä¸Šæ¥¼') || cmd.includes('up')) {
                    this.useStairs('up');
                    return;
                }
                if (cmd.includes('ä¸‹æ¥¼') || cmd.includes('down')) {
                    this.useStairs('down');
                    return;
                }

                // æ”»å‡»
                if (cmd.includes('æ”»å‡»') || cmd.includes('attack') || cmd.includes('æ‰“')) {
                    this.attack();
                    return;
                }

                // æ£€æŸ¥/æœç´¢
                if (cmd.includes('æ£€æŸ¥') || cmd.includes('æœç´¢') || cmd.includes('look') || cmd.includes('search')) {
                    this.search();
                    return;
                }

                // èƒŒåŒ…
                if (cmd.includes('èƒŒåŒ…') || cmd.includes('inventory') || cmd.includes('bag')) {
                    this.showInventory();
                    return;
                }

                // çŠ¶æ€
                if (cmd.includes('çŠ¶æ€') || cmd.includes('status') || cmd.includes('stats')) {
                    this.showStatus();
                    return;
                }

                // ä½¿ç”¨ç‰©å“
                if (cmd.includes('ä½¿ç”¨') || cmd.includes('use') || cmd.includes('å–') || cmd.includes('åƒ')) {
                    this.useItem(cmd);
                    return;
                }

                // æ‹¾å–
                if (cmd.includes('æ‹¾å–') || cmd.includes('æ¡') || cmd.includes('æ‹¿') || cmd.includes('take') || cmd.includes('pick')) {
                    this.pickupItem(cmd);
                    return;
                }

                // åœ°å›¾
                if (cmd.includes('åœ°å›¾') || cmd.includes('map')) {
                    this.showMapInfo();
                    return;
                }

                // å¸®åŠ©
                if (cmd.includes('å¸®åŠ©') || cmd.includes('help') || cmd.includes('?')) {
                    this.showHelp();
                    return;
                }

                this.addLog(`æœªçŸ¥å‘½ä»¤: "${command}"ã€‚è¾“å…¥"å¸®åŠ©"æŸ¥çœ‹å¯ç”¨å‘½ä»¤ã€‚`, 'info');
            }

            attack() {
                if (!this.inCombat) {
                    this.addLog('è¿™é‡Œæ²¡æœ‰æ•Œäººå¯ä»¥æ”»å‡»ã€‚', 'info');
                    return;
                }

                // ç©å®¶æ”»å‡»
                const weapon = this.player.inventory.find(i => i.type === 'weapon');
                const baseDamage = weapon ? weapon.damage : 2;
                const damage = baseDamage + Math.floor(Math.random() * 5);
                
                this.currentEnemy.currentHp -= damage;
                this.addLog(`ä½ ç”¨${weapon ? weapon.name : 'æ‹³å¤´'}æ”»å‡» ${this.currentEnemy.name}ï¼Œé€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`, 'combat');
                this.updateEnemyHp();

                // æ£€æŸ¥æ•Œäººæ­»äº¡
                if (this.currentEnemy.currentHp <= 0) {
                    this.defeatEnemy();
                    return;
                }

                // æ•Œäººåå‡»
                setTimeout(() => {
                    const enemyDamage = Math.max(1, this.currentEnemy.damage - Math.floor(Math.random() * 5));
                    this.player.hp -= enemyDamage;
                    this.addLog(`${this.currentEnemy.name} åå‡»ï¼Œé€ æˆ ${enemyDamage} ç‚¹ä¼¤å®³ï¼`, 'combat');
                    
                    if (this.player.hp <= 0) {
                        this.player.hp = 0;
                        this.addLog('ä½ å€’ä¸‹äº†... æ¸¸æˆç»“æŸï¼', 'combat');
                        this.addLog('åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹ã€‚', 'info');
                    }
                    
                    this.updateUI();
                }, 500);
            }

            defeatEnemy() {
                const enemy = this.currentEnemy;
                this.addLog(`ä½ å‡»è´¥äº† ${enemy.name}ï¼`, 'success');
                this.addLog(`è·å¾— ${enemy.xp} ç»éªŒå€¼ï¼`, 'success');
                
                this.player.xp += enemy.xp;
                this.checkLevelUp();
                
                // æ‰è½ç‰©å“
                if (enemy.loot) {
                    enemy.loot.forEach(item => {
                        this.player.inventory.push(item);
                        this.addLog(`è·å¾—æˆ˜åˆ©å“: ${item.name}`, 'loot');
                    });
                }
                
                this.flags[`defeated_${enemy.id}_${this.currentLocation}`] = true;
                this.endCombat();
                this.updateUI();
                this.renderMiniMap(); // æ›´æ–°åœ°å›¾ï¼Œæ•Œäººæ ‡è®°æ¶ˆå¤±
            }

            checkLevelUp() {
                if (this.player.xp >= this.player.xpToNext) {
                    this.player.level++;
                    this.player.xp -= this.player.xpToNext;
                    this.player.xpToNext = Math.floor(this.player.xpToNext * 1.5);
                    this.player.maxHp += 25;
                    this.player.hp = this.player.maxHp;
                    this.addLog(`ğŸ‰ å‡çº§äº†ï¼ä½ ç°åœ¨ç­‰çº§ ${this.player.level}ï¼`, 'success');
                    this.addLog('ç”Ÿå‘½å€¼å·²å®Œå…¨æ¢å¤ï¼', 'success');
                }
            }

            search() {
                const location = ROOMS[this.currentLocation];
                
                if (this.inCombat) {
                    this.addLog('æˆ˜æ–—ä¸­æ— æ³•æœç´¢ï¼', 'combat');
                    return;
                }

                // æœç´¢åœºæ™¯ç‰©å“
                if (location.items && location.items.length > 0) {
                    this.addLog('ä½ å‘ç°äº†:', 'info');
                    location.items.forEach(item => {
                        this.addLog(`  â€¢ ${item.name} - ${item.description}`, 'loot');
                    });
                    this.addLog('ä½¿ç”¨ "æ‹¾å– [ç‰©å“å]" æ¥æ‹¿å–ï¼Œæˆ–ç›´æ¥ç‚¹å‡»"ä¸€é”®æ‹¾å–"ã€‚', 'info');
                } else {
                    this.addLog('ä½ ä»”ç»†æœç´¢äº†è¿™ä¸ªåŒºåŸŸï¼Œä½†æ²¡æœ‰å‘ç°ä»€ä¹ˆç‰¹åˆ«çš„ä¸œè¥¿ã€‚', 'info');
                }
                
                // æ˜¾ç¤ºå¯ç§»åŠ¨æ–¹å‘
                const exits = Object.keys(location.exits);
                if (exits.length > 0) {
                    const exitNames = exits.map(e => this.getDirectionName(e)).join('ã€');
                    this.addLog(`ä½ å¯ä»¥å‘ ${exitNames} æ–¹å‘ç§»åŠ¨ã€‚`, 'info');
                }
            }

            pickupItem(cmd) {
                const location = ROOMS[this.currentLocation];
                
                if (!location.items || location.items.length === 0) {
                    this.addLog('è¿™é‡Œæ²¡æœ‰å¯ä»¥æ‹¾å–çš„ç‰©å“ã€‚', 'info');
                    return;
                }

                // ç®€å•å¤„ç†ï¼šæ‹¾å–æ‰€æœ‰ç‰©å“
                location.items.forEach(item => {
                    this.player.inventory.push(item);
                    this.addLog(`æ‹¾å–äº†: ${item.name}`, 'success');
                });
                location.items = [];
                this.updateUI();
                this.updatePickupButton();
            }

            pickupAll() {
                const location = ROOMS[this.currentLocation];
                
                if (this.inCombat) {
                    this.addLog('æˆ˜æ–—ä¸­æ— æ³•æ‹¾å–ç‰©å“ï¼', 'combat');
                    return;
                }
                
                if (!location.items || location.items.length === 0) {
                    this.addLog('è¿™é‡Œæ²¡æœ‰å¯ä»¥æ‹¾å–çš„ç‰©å“ã€‚', 'info');
                    return;
                }

                const itemCount = location.items.length;
                location.items.forEach(item => {
                    this.player.inventory.push(item);
                });
                location.items = [];
                
                this.addLog(`ğŸ“¦ ä¸€é”®æ‹¾å–äº† ${itemCount} ä»¶ç‰©å“ï¼`, 'success');
                this.updateUI();
                this.updatePickupButton();
            }

            updatePickupButton() {
                const location = ROOMS[this.currentLocation];
                const btn = document.getElementById('pickup-all-btn');
                if (location.items && location.items.length > 0) {
                    btn.style.display = 'inline-block';
                } else {
                    btn.style.display = 'none';
                }
            }

            updateStairsButtons() {
                const location = ROOMS[this.currentLocation];
                const upBtn = document.getElementById('stairs-up-btn');
                const downBtn = document.getElementById('stairs-down-btn');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šæ¥¼å‡ºå£
                const hasUp = location.exits.up || (location.exits.north && ROOMS[location.exits.north]?.type === 'stairs_up');
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹æ¥¼å‡ºå£
                const hasDown = location.exits.down || (location.exits.south && ROOMS[location.exits.south]?.type === 'stairs_down');
                
                // æ›´ç²¾ç¡®çš„æ£€æŸ¥
                const canGoUp = location.exits.up !== undefined || location.type === 'stairs_up' || 
                    Object.values(location.exits).some(id => ROOMS[id]?.type === 'stairs_up');
                const canGoDown = location.exits.down !== undefined || location.type === 'stairs_down' ||
                    Object.values(location.exits).some(id => ROOMS[id]?.type === 'stairs_down');
                
                // æ ¹æ®æˆ¿é—´ç±»å‹åˆ¤æ–­
                if (location.type === 'stairs_up' || location.exits.up) {
                    upBtn.style.display = 'inline-block';
                } else {
                    upBtn.style.display = 'none';
                }
                
                if (location.type === 'stairs_down' || location.exits.down) {
                    downBtn.style.display = 'inline-block';
                } else {
                    downBtn.style.display = 'none';
                }
            }

            useItem(cmd) {
                // æŸ¥æ‰¾æ¶ˆè€—å“
                const consumables = this.player.inventory.filter(i => i.type === 'consumable');
                
                if (consumables.length === 0) {
                    this.addLog('ä½ æ²¡æœ‰å¯ä»¥ä½¿ç”¨çš„æ¶ˆè€—å“ã€‚', 'info');
                    return;
                }

                // ä¼˜å…ˆä½¿ç”¨æ²»ç–—è¯æ°´
                const potion = consumables.find(i => i.id.includes('potion') || i.id.includes('healing'));
                if (potion && potion.heal) {
                    this.heal(potion.heal);
                    potion.quantity--;
                    if (potion.quantity <= 0) {
                        this.player.inventory = this.player.inventory.filter(i => i !== potion);
                    }
                    this.addLog(`ä½¿ç”¨äº† ${potion.name}ï¼Œæ¢å¤ ${potion.heal} HPï¼`, 'success');
                    this.updateUI();
                    return;
                }

                // ä½¿ç”¨é£Ÿç‰©
                const food = consumables.find(i => i.id.includes('bread'));
                if (food && food.heal) {
                    this.heal(food.heal);
                    food.quantity--;
                    if (food.quantity <= 0) {
                        this.player.inventory = this.player.inventory.filter(i => i !== food);
                    }
                    this.addLog(`åƒæ‰äº† ${food.name}ï¼Œæ¢å¤ ${food.heal} HPï¼`, 'success');
                    this.updateUI();
                    return;
                }

                this.addLog('æ²¡æœ‰å¯ä»¥ä½¿ç”¨ç‰©å“ã€‚', 'info');
            }

            heal(amount) {
                const oldHp = this.player.hp;
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + amount);
                const healed = this.player.hp - oldHp;
                return healed;
            }

            showInventory() {
                if (this.player.inventory.length === 0) {
                    this.addLog('ä½ çš„èƒŒåŒ…æ˜¯ç©ºçš„ã€‚', 'info');
                    return;
                }

                this.addLog('ğŸ’ èƒŒåŒ…å†…å®¹:', 'info');
                this.player.inventory.forEach(item => {
                    const qty = item.quantity ? ` x${item.quantity}` : '';
                    const stats = item.damage ? ` (æ”»å‡»+${item.damage})` : item.defense ? ` (é˜²å¾¡+${item.defense})` : '';
                    this.addLog(`  â€¢ ${item.name}${qty}${stats} - ${item.description}`, 'info');
                });
            }

            showStatus() {
                this.addLog('ğŸ“Š è§’è‰²çŠ¶æ€:', 'info');
                this.addLog(`  åç§°: ${this.player.name}`, 'info');
                this.addLog(`  ç­‰çº§: ${this.player.level}`, 'info');
                this.addLog(`  HP: ${this.player.hp}/${this.player.maxHp}`, 'info');
                this.addLog(`  ç»éªŒ: ${this.player.xp}/${this.player.xpToNext}`, 'info');
                this.addLog(`  é‡‘å¸: ${this.player.gold}`, 'info');
                this.addLog(`  å½“å‰ä½ç½®: ${FLOORS[this.currentFloor].name}`, 'info');
            }

            showMapInfo() {
                const location = ROOMS[this.currentLocation];
                const exploredCount = this.exploredRooms.filter(id => ROOMS[id].floor === this.currentFloor).length;
                const totalCount = Object.values(ROOMS).filter(r => r.floor === this.currentFloor).length;
                
                this.addLog('ğŸ—ºï¸ åœ°å›¾ä¿¡æ¯:', 'info');
                this.addLog(`  å½“å‰æ¥¼å±‚: ${FLOORS[this.currentFloor].name}`, 'info');
                this.addLog(`  æœ¬å±‚æ¢ç´¢è¿›åº¦: ${exploredCount}/${totalCount} æˆ¿é—´`, 'info');
                this.addLog(`  æ€»æ¢ç´¢æˆ¿é—´æ•°: ${this.exploredRooms.length}`, 'info');
                
                const exits = Object.keys(location.exits);
                if (exits.length > 0) {
                    this.addLog(`  å¯ç”¨å‡ºå£: ${exits.map(e => this.getDirectionName(e)).join('ã€')}`, 'info');
                }
            }

            showHelp() {
                this.addLog('â“ å¯ç”¨å‘½ä»¤:', 'info');
                this.addLog('  ç§»åŠ¨: åŒ—/å—/ä¸œ/è¥¿ (æˆ–WASD/æ–¹å‘é”®)', 'info');
                this.addLog('  æ¥¼å±‚: ä¸Šæ¥¼/ä¸‹æ¥¼ (æˆ–ç‚¹å‡»æ¥¼æ¢¯æŒ‰é’®)', 'info');
                this.addLog('  æˆ˜æ–—: æ”»å‡», æ‰“', 'info');
                this.addLog('  æ¢ç´¢: æ£€æŸ¥, æœç´¢', 'info');
                this.addLog('  ç‰©å“: æ‹¾å–, ä½¿ç”¨, èƒŒåŒ…', 'info');
                this.addLog('  ä¿¡æ¯: çŠ¶æ€, åœ°å›¾', 'info');
                this.addLog('  å…¶ä»–: å¸®åŠ©', 'info');
                this.addLog('', 'info');
                this.addLog('ğŸ’¡ æç¤º: å°åœ°å›¾æ˜¾ç¤ºäº†å·²æ¢ç´¢å’Œæœªæ¢ç´¢åŒºåŸŸ', 'info');
                this.addLog('ğŸ’¡ æç¤º: ä¸åŒæ¥¼å±‚æœ‰ä¸åŒä¸»é¢˜å’Œéš¾åº¦', 'info');
            }

            addLog(message, type = 'info') {
                this.logs.push({ message, type });
                if (this.logs.length > 50) {
                    this.logs.shift();
                }
                this.renderLogs();
            }

            renderLogs() {
                const logPanel = document.getElementById('log-panel');
                logPanel.innerHTML = this.logs.map(log => 
                    `<div class="log-entry ${log.type}">${log.message}</div>`
                ).join('');
                logPanel.scrollTop = logPanel.scrollHeight;
            }

            updateUI() {
                // æ›´æ–°ç©å®¶ä¿¡æ¯
                document.getElementById('player-name').textContent = this.player.name;
                document.getElementById('player-level').textContent = this.player.level;
                document.getElementById('player-xp').textContent = `${this.player.xp}/${this.player.xpToNext}`;
                document.getElementById('player-gold').textContent = this.player.gold;
                document.getElementById('current-hp').textContent = this.player.hp;
                document.getElementById('max-hp').textContent = this.player.maxHp;

                // æ›´æ–°HPæ¡
                const hpPercent = (this.player.hp / this.player.maxHp) * 100;
                document.getElementById('hp-bar').style.width = `${hpPercent}%`;

                // æ›´æ–°èƒŒåŒ…
                const inventoryList = document.getElementById('inventory-list');
                if (this.player.inventory.length === 0) {
                    inventoryList.innerHTML = '<div style="color: #555; font-style: italic;">èƒŒåŒ…æ˜¯ç©ºçš„</div>';
                } else {
                    inventoryList.innerHTML = this.player.inventory.map(item => {
                        const qty = item.quantity ? ` x${item.quantity}` : '';
                        const icon = item.type === 'weapon' ? 'âš”ï¸' : item.type === 'armor' ? 'ğŸ›¡ï¸' : item.type === 'consumable' ? 'ğŸ§ª' : 'ğŸ“¦';
                        return `
                            <div class="inventory-item" onclick="game.quickCommand('ä½¿ç”¨ ${item.name}')">
                                <div class="item-name">${icon} ${item.name}${qty}</div>
                                <div class="item-desc">${item.description}</div>
                            </div>
                        `;
                    }).join('');
                }
            }

            saveGame() {
                const saveData = {
                    player: this.player,
                    currentLocation: this.currentLocation,
                    currentFloor: this.currentFloor,
                    exploredRooms: this.exploredRooms,
                    floorExploration: this.floorExploration,
                    flags: this.flags,
                    logs: this.logs,
                    saveTime: new Date().toISOString()
                };
                
                localStorage.setItem('forgotten_dungeon_save_v2', JSON.stringify(saveData));
                this.addLog('ğŸ’¾ æ¸¸æˆå·²ä¿å­˜ï¼', 'success');
            }

            loadGame() {
                const saveData = localStorage.getItem('forgotten_dungeon_save_v2');
                
                if (!saveData) {
                    this.addLog('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£ã€‚', 'info');
                    return;
                }

                try {
                    const data = JSON.parse(saveData);
                    this.player = data.player;
                    this.currentLocation = data.currentLocation;
                    this.currentFloor = data.currentFloor || 'surface';
                    this.exploredRooms = data.exploredRooms || [];
                    this.floorExploration = data.floorExploration || this.createDefaultExploration();
                    this.flags = data.flags;
                    this.logs = data.logs || [];
                    
                    this.addLog(`ğŸ“‚ æ¸¸æˆå·²åŠ è½½ï¼(å­˜æ¡£æ—¶é—´: ${new Date(data.saveTime).toLocaleString()})`, 'success');
                    this.renderScene();
                    this.updateUI();
                } catch (e) {
                    this.addLog('å­˜æ¡£æŸåï¼Œæ— æ³•åŠ è½½ã€‚', 'combat');
                    console.error(e);
                }
            }

            createDefaultExploration() {
                return {
                    surface: this.createEmptyGrid(),
                    b1: this.createEmptyGrid(),
                    b2: this.createEmptyGrid(),
                    b3: this.createEmptyGrid()
                };
            }
        }

        // å¯åŠ¨æ¸¸æˆ
        const game = new ForgottenDungeon();
    </script>
</body>
</html>
